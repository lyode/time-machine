<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Personal Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #ecf0f1;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.8;
            margin-bottom: 20px;
        }

        .trust-level {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: rgba(52, 152, 219, 0.2);
            padding: 10px 20px;
            border-radius: 25px;
            border: 1px solid rgba(52, 152, 219, 0.5);
        }

        .main-layout {
            display: grid;
            grid-template-columns: 350px 1fr 300px;
            gap: 25px;
            height: calc(100vh - 150px);
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
        }

        .privacy-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
        }

        .chat-area {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
        }

        .assistant-header {
            padding: 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .assistant-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }

        .assistant-info h3 {
            margin: 0 0 5px 0;
            font-size: 1.3rem;
        }

        .assistant-status {
            font-size: 0.9rem;
            opacity: 0.7;
        }

        .clearance-badge {
            margin-left: auto;
            padding: 8px 15px;
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid rgba(46, 204, 113, 0.5);
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .chat-messages {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
        }

        .message {
            margin: 20px 0;
            padding: 15px 20px;
            border-radius: 18px;
            max-width: 80%;
            line-height: 1.5;
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid rgba(52, 152, 219, 0.3);
            margin-left: auto;
            text-align: right;
        }

        .message.assistant {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid rgba(46, 204, 113, 0.3);
            margin-right: auto;
        }

        .message-meta {
            font-size: 0.8rem;
            opacity: 0.6;
            margin-top: 8px;
        }

        .thinking {
            display: none;
            padding: 15px 20px;
            background: rgba(241, 196, 15, 0.2);
            border: 1px solid rgba(241, 196, 15, 0.3);
            border-radius: 18px;
            margin: 10px 0;
            max-width: 300px;
            align-items: center;
            gap: 10px;
        }

        .thinking-dots {
            display: flex;
            gap: 4px;
        }

        .thinking-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #f1c40f;
            animation: thinkingPulse 1.4s infinite ease-in-out;
        }

        .thinking-dot:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes thinkingPulse {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .input-area {
            padding: 25px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .input-container {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .input-field {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 15px 20px;
            color: white;
            font-size: 1rem;
            resize: none;
            min-height: 50px;
            max-height: 120px;
            outline: none;
        }

        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .voice-btn, .send-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .voice-btn.listening {
            background: linear-gradient(135deg, #27ae60, #229954);
            animation: pulse 1.5s infinite;
        }

        .send-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .privacy-section {
            margin-bottom: 25px;
        }

        .privacy-header {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #3498db;
        }

        .privacy-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .privacy-toggle {
            width: 50px;
            height: 25px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .privacy-toggle.active {
            background: #27ae60;
        }

        .privacy-slider {
            width: 21px;
            height: 21px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
        }

        .privacy-toggle.active .privacy-slider {
            transform: translateX(25px);
        }

        .clearance-level {
            background: rgba(155, 89, 182, 0.2);
            border: 1px solid rgba(155, 89, 182, 0.5);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .data-summary {
            background: rgba(52, 73, 94, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
        }

        .data-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-item:last-child {
            border-bottom: none;
        }

        .insights-panel {
            background: rgba(230, 126, 34, 0.1);
            border: 1px solid rgba(230, 126, 34, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
        }

        .insight-item {
            padding: 10px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .api-setup {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .api-input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            margin: 10px 0;
        }

        .api-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            background: rgba(52, 152, 219, 0.3);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            background: rgba(52, 152, 219, 0.5);
        }

        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .sidebar, .privacy-panel {
                order: 2;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Your Personal Assistant</h1>
            <p class="subtitle">Trusted with your private information ‚Ä¢ Intelligent analysis ‚Ä¢ Proactive assistance</p>
            <div class="trust-level">
                <span>üîí</span>
                <span>Clearance Level: <strong id="clearanceLevel">Basic</strong></span>
                <span id="trustScore">Trust Score: 45%</span>
            </div>
        </div>

        <div class="main-layout">
            <!-- Left Sidebar - Data Access -->
            <div class="sidebar">
                <!-- API Setup -->
                <div class="api-setup" id="apiSetup">
                    <h3>üß† Assistant Intelligence</h3>
                    <p style="font-size: 0.9rem; margin: 10px 0;">Connect AI brain for intelligent analysis:</p>
                    <input type="password" class="api-input" id="apiKey" placeholder="OpenAI API Key">
                    <button class="btn" onclick="connectAI()">Connect</button>
                </div>

                <div class="privacy-section">
                    <div class="privacy-header">üìä Data Access Permissions</div>
                    
                    <div class="privacy-item">
                        <span>üìÖ Calendar & Schedule</span>
                        <div class="privacy-toggle" id="calendarToggle" onclick="togglePrivacy('calendar')">
                            <div class="privacy-slider"></div>
                        </div>
                    </div>
                    
                    <div class="privacy-item">
                        <span>üìß Email & Messages</span>
                        <div class="privacy-toggle" id="emailToggle" onclick="togglePrivacy('email')">
                            <div class="privacy-slider"></div>
                        </div>
                    </div>
                    
                    <div class="privacy-item">
                        <span>üë• Contacts & Relationships</span>
                        <div class="privacy-toggle" id="contactsToggle" onclick="togglePrivacy('contacts')">
                            <div class="privacy-slider"></div>
                        </div>
                    </div>
                    
                    <div class="privacy-item">
                        <span>üìç Location & Travel</span>
                        <div class="privacy-toggle" id="locationToggle" onclick="togglePrivacy('location')">
                            <div class="privacy-slider"></div>
                        </div>
                    </div>
                    
                    <div class="privacy-item">
                        <span>üí≥ Financial Information</span>
                        <div class="privacy-toggle" id="financialToggle" onclick="togglePrivacy('financial')">
                            <div class="privacy-slider"></div>
                        </div>
                    </div>
                    
                    <div class="privacy-item">
                        <span>üè• Health & Wellness</span>
                        <div class="privacy-toggle" id="healthToggle" onclick="togglePrivacy('health')">
                            <div class="privacy-slider"></div>
                        </div>
                    </div>
                    
                    <div class="privacy-item">
                        <span>üíº Work & Projects</span>
                        <div class="privacy-toggle" id="workToggle" onclick="togglePrivacy('work')">
                            <div class="privacy-slider"></div>
                        </div>
                    </div>
                </div>

                <div class="data-summary">
                    <div class="privacy-header">üìà Data Summary</div>
                    <div class="data-item">
                        <span>Calendar Events</span>
                        <span id="calendarCount">0</span>
                    </div>
                    <div class="data-item">
                        <span>Contacts</span>
                        <span id="contactsCount">0</span>
                    </div>
                    <div class="data-item">
                        <span>Messages</span>
                        <span id="messagesCount">0</span>
                    </div>
                    <div class="data-item">
                        <span>Financial Records</span>
                        <span id="financialCount">0</span>
                    </div>
                </div>

                <button class="btn" onclick="loadSampleData()" style="width: 100%; margin-top: 15px;">
                    üì• Load Sample Personal Data
                </button>
            </div>

            <!-- Main Chat Area -->
            <div class="chat-area">
                <div class="assistant-header">
                    <div class="assistant-avatar">ü§ñ</div>
                    <div class="assistant-info">
                        <h3 id="assistantName">Personal Assistant</h3>
                        <div class="assistant-status" id="assistantStatus">Ready to assist with full context analysis</div>
                    </div>
                    <div class="clearance-badge" id="clearanceBadge">Basic Access</div>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <div class="message assistant">
                        Hello! I'm your personal assistant. I can analyze your personal information intelligently to provide insights, make recommendations, and help manage your life more effectively. 
                        
                        The more access you grant me to your personal data, the better I can serve you. I'll treat all information with complete confidentiality and use it only to help you.
                        
                        What would you like assistance with today?
                    </div>
                </div>

                <div class="thinking" id="thinkingIndicator">
                    <span>üß† Analyzing your personal data</span>
                    <div class="thinking-dots">
                        <div class="thinking-dot"></div>
                        <div class="thinking-dot"></div>
                        <div class="thinking-dot"></div>
                    </div>
                </div>

                <div class="input-area">
                    <div class="input-container">
                        <textarea class="input-field" id="messageInput" placeholder="Ask me anything about your schedule, contacts, finances, or need analysis of your personal situation..." rows="1"></textarea>
                        <button class="voice-btn" id="voiceBtn" onclick="toggleVoice()">üé§</button>
                        <button class="send-btn" onclick="sendMessage()">üì§</button>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Privacy & Insights -->
            <div class="privacy-panel">
                <div class="clearance-level">
                    <div class="privacy-header">üîê Current Clearance</div>
                    <div id="clearanceDescription">Basic level access granted. Grant more permissions for deeper insights.</div>
                </div>

                <div class="privacy-section">
                    <div class="privacy-header">üéØ Smart Insights</div>
                    <div class="insights-panel" id="insightsPanel">
                        <div class="insight-item">Grant calendar access to see schedule optimization opportunities</div>
                        <div class="insight-item">Enable contact analysis for relationship insights</div>
                        <div class="insight-item">Connect financial data for spending pattern analysis</div>
                    </div>
                </div>

                <div class="privacy-section">
                    <div class="privacy-header">‚ö° Quick Actions</div>
                    <button class="btn" onclick="quickAnalysis('schedule')" style="width: 100%; margin: 5px 0;">üìÖ Analyze My Schedule</button>
                    <button class="btn" onclick="quickAnalysis('priorities')" style="width: 100%; margin: 5px 0;">üéØ Priority Assessment</button>
                    <button class="btn" onclick="quickAnalysis('patterns')" style="width: 100%; margin: 5px 0;">üìä Behavior Patterns</button>
                    <button class="btn" onclick="quickAnalysis('recommendations')" style="width: 100%; margin: 5px 0;">üí° Personal Recommendations</button>
                </div>

                <div class="privacy-section">
                    <div class="privacy-header">üõ°Ô∏è Privacy Controls</div>
                    <button class="btn" onclick="viewDataUsage()" style="width: 100%; margin: 5px 0;">üìã Data Usage Log</button>
                    <button class="btn" onclick="adjustPrivacy()" style="width: 100%; margin: 5px 0;">‚öôÔ∏è Adjust Privacy</button>
                    <button class="btn" onclick="exportData()" style="width: 100%; margin: 5px 0;">üì§ Export My Data</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class IntelligentPersonalAssistant {
            constructor() {
                this.permissions = {
                    calendar: false,
                    email: false,
                    contacts: false,
                    location: false,
                    financial: false,
                    health: false,
                    work: false
                };
                
                this.personalData = {
                    calendar: [],
                    emails: [],
                    contacts: [],
                    locations: [],
                    financial: [],
                    health: [],
                    work: []
                };
                
                this.settings = {
                    apiKey: localStorage.getItem('pa_api_key') || '',
                    trustLevel: 'basic',
                    privacyMode: 'standard'
                };
                
                this.conversationHistory = [];
                this.insights = [];
                this.dataUsageLog = [];
                
                this.isListening = false;
                this.recognition = null;
                this.synthesis = window.speechSynthesis;
                
                this.initializeVoiceRecognition();
                this.updateUI();
                this.loadPersonalData();
                
                console.log('ü§ñ Intelligent Personal Assistant initialized');
            }
            
            initializeVoiceRecognition() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;
                    this.recognition.lang = 'en-US';
                    
                    this.recognition.onstart = () => {
                        this.isListening = true;
                        document.getElementById('voiceBtn').classList.add('listening');
                    };
                    
                    this.recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        this.processMessage(transcript);
                    };
                    
                    this.recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        this.stopListening();
                    };
                    
                    this.recognition.onend = () => {
                        this.stopListening();
                    };
                }
            }
            
            togglePrivacy(dataType) {
                this.permissions[dataType] = !this.permissions[dataType];
                this.updateToggle(dataType);
                this.updateTrustLevel();
                this.updateInsights();
                this.logDataUsage(`${dataType} access ${this.permissions[dataType] ? 'granted' : 'revoked'}`);
                
                if (this.permissions[dataType]) {
                    this.addMessage(`Great! I now have access to your ${dataType} data. This allows me to provide much more personalized and intelligent assistance.`, 'assistant');
                } else {
                    this.addMessage(`I've removed access to your ${dataType} data. My assistance in that area will be more limited now.`, 'assistant');
                }
                
                this.savePermissions();
            }
            
            updateToggle(dataType) {
                const toggle = document.getElementById(`${dataType}Toggle`);
                if (toggle) {
                    toggle.classList.toggle('active', this.permissions[dataType]);
                }
            }
            
            updateTrustLevel() {
                const permissionCount = Object.values(this.permissions).filter(p => p).length;
                const totalPermissions = Object.keys(this.permissions).length;
                const trustPercentage = Math.round((permissionCount / totalPermissions) * 100);
                
                let trustLevel = 'basic';
                let clearanceDesc = 'Basic level access granted.';
                
                if (trustPercentage >= 80) {
                    trustLevel = 'maximum';
                    clearanceDesc = 'Maximum trust level - Full personal analysis available. I can provide comprehensive insights across all areas of your life.';
                } else if (trustPercentage >= 60) {
                    trustLevel = 'high';
                    clearanceDesc = 'High trust level - Advanced analysis available. I can cross-reference multiple data sources for deeper insights.';
                } else if (trustPercentage >= 40) {
                    trustLevel = 'medium';
                    clearanceDesc = 'Medium trust level - Moderate analysis available. Some cross-data insights possible.';
                } else if (trustPercentage >= 20) {
                    trustLevel = 'limited';
                    clearanceDesc = 'Limited trust level - Basic analysis with some personal context.';
                }
                
                this.settings.trustLevel = trustLevel;
                document.getElementById('clearanceLevel').textContent = trustLevel.charAt(0).toUpperCase() + trustLevel.slice(1);
                document.getElementById('trustScore').textContent = `Trust Score: ${trustPercentage}%`;
                document.getElementById('clearanceBadge').textContent = `${trustLevel.charAt(0).toUpperCase() + trustLevel.slice(1)} Access`;
                document.getElementById('clearanceDescription').textContent = clearanceDesc;
            }
            
            async processMessage(message) {
                this.addMessage(message, 'user');
                this.showThinking();
                
                try {
                    const response = await this.generateIntelligentResponse(message);
                    this.hideThinking();
                    this.addMessage(response, 'assistant');
                    
                    // Store conversation
                    this.conversationHistory.push({
                        timestamp: new Date(),
                        user: message,
                        assistant: response,
                        trustLevel: this.settings.trustLevel,
                        permissionsUsed: this.getRelevantPermissions(message)
                    });
                    
                    // Log data usage if personal data was accessed
                    this.logDataAccess(message);
                    
                } catch (error) {
                    this.hideThinking();
                    const fallback = this.getFallbackResponse();
                    this.addMessage(fallback, 'assistant');
                }
            }
            
            async generateIntelligentResponse(message) {
                if (!this.settings.apiKey) {
                    return "I need my AI brain connected to provide intelligent analysis. Please add your OpenAI API key to unlock my full analytical capabilities.";
                }
                
                const context = this.buildPersonalContext(message);
                const systemPrompt = this.buildSystemPrompt();
                
                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.settings.apiKey}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: 'gpt-3.5-turbo',
                            messages: [
                                {
                                    role: 'system',
                                    content: systemPrompt
                                },
                                {
                                    role: 'user',
                                    content: context + "\n\nUser request: " + message
                                }
                            ],
                            max_tokens: 300,
                            temperature: 0.7
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    return data.choices[0].message.content.trim();
                    
                } catch (error) {
                    console.error('AI response error:', error);
                    throw error;
                }
            }
            
            buildSystemPrompt() {
                const permissionsList = Object.keys(this.permissions).filter(key => this.permissions[key]).join(', ');
                
                return `You are an intelligent personal assistant with ${this.settings.trustLevel} level access to the user's personal information. 

You have been granted access to: ${permissionsList || 'basic information only'}.

Your role is to:
1. Analyze the user's personal data intelligently and provide insights
2. Make connections between different data sources when you have access
3. Proactively identify patterns, problems, and opportunities
4. Provide personalized recommendations based on the available data
5. Act like a trusted personal assistant who knows the user well

Key behaviors:
- Be proactive and insightful, not just reactive
- Connect information from different sources when possible
- Identify patterns and trends in the user's data
- Make intelligent recommendations
- Protect the user's privacy and explain what data you're using
- Be honest about what you can and cannot analyze based on your access level

Respond naturally and intelligently, like a human personal assistant who has been trusted with personal information.`;
            }
            
            buildPersonalContext(message) {
                let context = `Personal Context Available:\n`;
                context += `Trust Level: ${this.settings.trustLevel}\n`;
                context += `Current Time: ${new Date().toLocaleString()}\n\n`;
                
                // Add relevant personal data based on permissions
                if (this.permissions.calendar && this.personalData.calendar.length > 0) {
                    context += `CALENDAR DATA:\n`;
                    context += this.personalData.calendar.slice(0, 5).map(event => 
                        `- ${event.title} on ${new Date(event.date).toLocaleDateString()} at ${event.time}`
                    ).join('\n') + '\n\n';
                }
                
                if (this.permissions.contacts && this.personalData.contacts.length > 0) {
                    context += `CONTACTS DATA:\n`;
                    context += this.personalData.contacts.slice(0, 10).map(contact => 
                        `- ${contact.name}: ${contact.relationship} (${contact.frequency} contact)`
                    ).join('\n') + '\n\n';
                }
                
                if (this.permissions.financial && this.personalData.financial.length > 0) {
                    context += `FINANCIAL DATA:\n`;
                    context += this.personalData.financial.slice(0, 5).map(item => 
                        `- ${item.category}: $${item.amount} (${item.type})`
                    ).join('\n') + '\n\n';
                }
                
                if (this.permissions.work && this.personalData.work.length > 0) {
                    context += `WORK DATA:\n`;
                    context += this.personalData.work.slice(0, 5).map(item => 
                        `- ${item.project}: ${item.status} (Priority: ${item.priority})`
                    ).join('\n') + '\n\n';
                }
                
                // Add recent conversation context
                if (this.conversationHistory.length > 0) {
                    const recentHistory = this.conversationHistory.slice(-3);
                    context += `RECENT CONVERSATION:\n`;
                    context += recentHistory.map(conv => 
                        `User: "${conv.user}"\nAssistant: "${conv.assistant.substring(0, 100)}..."`
                    ).join('\n') + '\n\n';
                }
                
                context += `Use this personal information to provide intelligent, personalized assistance. Make connections between different data sources when relevant.`;
                
                return context;
            }
            
            getRelevantPermissions(message) {
                const relevantPerms = [];
                const lowerMessage = message.toLowerCase();
                
                if (lowerMessage.includes('calendar') || lowerMessage.includes('schedule') || lowerMessage.includes('meeting')) {
                    relevantPerms.push('calendar');
                }
                if (lowerMessage.includes('contact') || lowerMessage.includes('call') || lowerMessage.includes('relationship')) {
                    relevantPerms.push('contacts');
                }
                if (lowerMessage.includes('money') || lowerMessage.includes('financial') || lowerMessage.includes('spend')) {
                    relevantPerms.push('financial');
                }
                if (lowerMessage.includes('work') || lowerMessage.includes('project') || lowerMessage.includes('job')) {
                    relevantPerms.push('work');
                }
                
                return relevantPerms.filter(perm => this.permissions[perm]);
            }
            
            logDataAccess(message) {
                const relevantPerms = this.getRelevantPermissions(message);
                if (relevantPerms.length > 0) {
                    this.logDataUsage(`Accessed ${relevantPerms.join(', ')} data for: "${message.substring(0, 50)}..."`);
                }
            }
            
            logDataUsage(action) {
                this.dataUsageLog.push({
                    timestamp: new Date(),
                    action: action,
                    trustLevel: this.settings.trustLevel
                });
                
                // Keep only last 100 entries
                if (this.dataUsageLog.length > 100) {
                    this.dataUsageLog = this.dataUsageLog.slice(-100);
                }
            }
            
            updateInsights() {
                const insights = [];
                const permissionCount = Object.values(this.permissions).filter(p => p).length;
                
                if (!this.permissions.calendar) {
                    insights.push("üìÖ Grant calendar access for schedule optimization and conflict detection");
                }
                if (!this.permissions.financial) {
                    insights.push("üí≥ Enable financial data for spending pattern analysis and budgeting insights");
                }
                if (!this.permissions.contacts) {
                    insights.push("üë• Connect contacts for relationship management and communication insights");
                }
                if (!this.permissions.work) {
                    insights.push("üíº Share work data for productivity analysis and project management");
                }
                
                if (permissionCount >= 3) {
                    insights.push("üîó Cross-referencing multiple data sources for comprehensive life insights");
                }
                if (permissionCount >= 5) {
                    insights.push("üß† Advanced pattern recognition across all personal data areas");
                }
                
                const insightsPanel = document.getElementById('insightsPanel');
                insightsPanel.innerHTML = insights.map(insight => 
                    `<div class="insight-item">${insight}</div>`
                ).join('');
            }
            
            // UI Methods
            addMessage(message, sender) {
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                
                const messageContent = document.createElement('div');
                messageContent.textContent = message;
                messageDiv.appendChild(messageContent);
                
                if (sender === 'assistant') {
                    const meta = document.createElement('div');
                    meta.className = 'message-meta';
                    meta.textContent = `Trust Level: ${this.settings.trustLevel} ‚Ä¢ ${new Date().toLocaleTimeString()}`;
                    messageDiv.appendChild(meta);
                }
                
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            showThinking() {
                document.getElementById('thinkingIndicator').style.display = 'flex';
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            hideThinking() {
                document.getElementById('thinkingIndicator').style.display = 'none';
            }
            
            updateUI() {
                // Update data counts
                document.getElementById('calendarCount').textContent = this.personalData.calendar.length;
                document.getElementById('contactsCount').textContent = this.personalData.contacts.length;
                document.getElementById('messagesCount').textContent = this.personalData.emails.length;
                document.getElementById('financialCount').textContent = this.personalData.financial.length;
                
                // Update API setup visibility
                document.getElementById('apiSetup').style.display = this.settings.apiKey ? 'none' : 'block';
                
                // Update all toggles
                Object.keys(this.permissions).forEach(key => {
                    this.updateToggle(key);
                });
                
                this.updateTrustLevel();
                this.updateInsights();
            }
            
            toggleVoice() {
                if (this.isListening) {
                    this.stopListening();
                } else {
                    this.startListening();
                }
            }
            
            startListening() {
                if (this.recognition && !this.isListening) {
                    try {
                        this.recognition.start();
                    } catch (error) {
                        console.error('Failed to start voice recognition:', error);
                    }
                }
            }
            
            stopListening() {
                this.isListening = false;
                document.getElementById('voiceBtn').classList.remove('listening');
            }
            
            getFallbackResponse() {
                return "I'm experiencing some technical difficulties, but I'm still here to help analyze your personal situation with the data I have access to.";
            }
            
            // Data Management
            loadPersonalData() {
                try {
                    const stored = localStorage.getItem('pa_personal_data');
                    if (stored) {
                        this.personalData = JSON.parse(stored);
                    }
                    
                    const permissions = localStorage.getItem('pa_permissions');
                    if (permissions) {
                        this.permissions = JSON.parse(permissions);
                    }
                } catch (error) {
                    console.error('Error loading personal data:', error);
                }
            }
            
            savePersonalData() {
                localStorage.setItem('pa_personal_data', JSON.stringify(this.personalData));
            }
            
            savePermissions() {
                localStorage.setItem('pa_permissions', JSON.stringify(this.permissions));
            }
        }
        
        // Global instance
        let assistant;
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            assistant = new IntelligentPersonalAssistant();
            
            // Event listeners
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Auto-resize textarea
            document.getElementById('messageInput').addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
            
            // Load API key if exists
            if (assistant.settings.apiKey) {
                document.getElementById('apiKey').value = assistant.settings.apiKey;
            }
        });
        
        // Global functions
        function togglePrivacy(dataType) {
            assistant.togglePrivacy(dataType);
        }
        
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (message) {
                assistant.processMessage(message);
                input.value = '';
                input.style.height = 'auto';
            }
        }
        
        function toggleVoice() {
            assistant.toggleVoice();
        }
        
        function connectAI() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (apiKey.startsWith('sk-')) {
                assistant.settings.apiKey = apiKey;
                localStorage.setItem('pa_api_key', apiKey);
                assistant.updateUI();
                assistant.addMessage('Perfect! My AI brain is now connected. I can provide much more intelligent analysis and insights based on your personal data.', 'assistant');
            } else {
                alert('Please enter a valid OpenAI API key (starts with sk-)');
            }
        }
        
        function quickAnalysis(type) {
            const analyses = {
                schedule: "Analyze my schedule for the next week and identify optimization opportunities, conflicts, and suggest improvements.",
                priorities: "Based on all my personal data, what should my top 3 priorities be right now? Consider my calendar, work projects, and personal goals.",
                patterns: "Analyze my behavior patterns across all the data you have access to. What insights can you provide about my habits, productivity, and lifestyle?",
                recommendations: "Give me personalized recommendations for improving my life based on comprehensive analysis of my personal data."
            };
            
            assistant.processMessage(analyses[type]);
        }
        
        function loadSampleData() {
            // Sample calendar data
            assistant.personalData.calendar = [
                { title: "Team Meeting", date: new Date(Date.now() + 86400000), time: "10:00 AM", type: "work" },
                { title: "Lunch with Sarah", date: new Date(Date.now() + 2*86400000), time: "12:30 PM", type: "personal" },
                { title: "Doctor Appointment", date: new Date(Date.now() + 3*86400000), time: "2:00 PM", type: "health" },
                { title: "Project Deadline", date: new Date(Date.now() + 5*86400000), time: "5:00 PM", type: "work" }
            ];
            
            // Sample contacts
            assistant.personalData.contacts = [
                { name: "Sarah Johnson", relationship: "Friend", frequency: "weekly", lastContact: "2 days ago" },
                { name: "Mom", relationship: "Family", frequency: "daily", lastContact: "yesterday" },
                { name: "John Smith", relationship: "Colleague", frequency: "daily", lastContact: "today" },
                { name: "Dr. Williams", relationship: "Healthcare", frequency: "monthly", lastContact: "2 weeks ago" }
            ];
            
            // Sample financial data
            assistant.personalData.financial = [
                { category: "Groceries", amount: 150, type: "expense", date: "2024-01-15" },
                { category: "Salary", amount: 4500, type: "income", date: "2024-01-01" },
                { category: "Rent", amount: 1200, type: "expense", date: "2024-01-01" },
                { category: "Utilities", amount: 200, type: "expense", date: "2024-01-05" }
            ];
            
            // Sample work data
            assistant.personalData.work = [
                { project: "Website Redesign", status: "In Progress", priority: "High", deadline: "2024-02-01" },
                { project: "Marketing Campaign", status: "Planning", priority: "Medium", deadline: "2024-02-15" },
                { project: "Client Presentation", status: "Complete", priority: "High", deadline: "2024-01-20" }
            ];
            
            assistant.savePersonalData();
            assistant.updateUI();
            assistant.addMessage('Sample personal data loaded! I now have access to your calendar, contacts, financial records, and work projects. This allows me to provide much more comprehensive analysis and insights.', 'assistant');
        }
        
        function viewDataUsage() {
            const usage = assistant.dataUsageLog.slice(-10).reverse();
            let message = "Recent data access log:\n\n";
            usage.forEach(log => {
                message += `${log.timestamp.toLocaleString()}: ${log.action}\n`;
            });
            assistant.addMessage(message, 'assistant');
        }
        
        function adjustPrivacy() {
            assistant.addMessage('You can adjust privacy settings using the toggles on the left. Each permission level gives me access to different types of analysis. Higher trust levels enable more comprehensive insights across your personal data.', 'assistant');
        }
        
        function exportData() {
            const data = {
                personalData: assistant.personalData,
                permissions: assistant.permissions,
                conversationHistory: assistant.conversationHistory,
                dataUsageLog: assistant.dataUsageLog,
                exported: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `personal-assistant-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            assistant.addMessage('Your personal data has been exported. This includes all your information, permissions, and our conversation history.', 'assistant');
        }
    </script>
</body>
</html>
