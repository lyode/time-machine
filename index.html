<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Natural AI Personal Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .main-interface {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            margin-bottom: 30px;
        }

        .chat-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            min-height: 600px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .message {
            margin: 15px 0;
            padding: 15px 20px;
            border-radius: 20px;
            max-width: 85%;
            word-wrap: break-word;
            animation: messageSlide 0.3s ease-out;
            line-height: 1.5;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            background: linear-gradient(135deg, #667eea, #764ba2);
            margin-left: auto;
            text-align: right;
            border-bottom-right-radius: 5px;
        }

        .message.ai {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }

        .thinking-indicator {
            display: none;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            margin: 10px 0;
            max-width: 200px;
            align-items: center;
            gap: 10px;
        }

        .thinking-dots {
            display: flex;
            gap: 4px;
        }

        .thinking-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: white;
            animation: thinkingBounce 1.4s infinite ease-in-out;
        }

        .thinking-dot:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes thinkingBounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .input-section {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .text-input {
            flex: 1;
            padding: 18px 25px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1rem;
            outline: none;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .text-input:focus {
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }

        .text-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .voice-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-btn:hover {
            transform: scale(1.05);
        }

        .voice-btn.listening {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            animation: pulse 1.5s infinite;
        }

        .voice-btn.processing {
            background: linear-gradient(135deg, #ffecd2, #fcb69f);
            animation: spin 2s linear infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .send-btn {
            padding: 18px 25px;
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            border: none;
            border-radius: 25px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .send-btn:hover {
            transform: translateY(-2px);
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sidebar-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .quick-settings {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
        }

        .toggle-switch {
            width: 50px;
            height: 25px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: #4ecdc4;
        }

        .toggle-slider {
            width: 21px;
            height: 21px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(25px);
        }

        .data-preview {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .data-item {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin: 5px 0;
            font-size: 0.9rem;
        }

        .api-setup {
            background: rgba(255, 152, 0, 0.1);
            border: 1px solid rgba(255, 152, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .api-input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            margin: 10px 0;
        }

        .api-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .btn.primary {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            display: inline-block;
        }

        .status-indicator.active {
            background: #4ecdc4;
            box-shadow: 0 0 10px #4ecdc4;
        }

        .status-indicator.inactive {
            background: #ff6b6b;
        }

        .context-info {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .main-interface {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                order: -1;
            }
        }

        .personality-indicator {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 15px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† Natural AI Assistant</h1>
            <p>Your intelligent companion that understands you naturally</p>
        </div>

        <div class="main-interface">
            <!-- Main Chat Section -->
            <div class="chat-section">
                <div class="personality-indicator" id="personalityStatus">
                    Natural conversational AI ready
                </div>

                <div class="chat-messages" id="chatMessages">
                    <div class="message ai">
                        Hi! I'm your personal AI assistant. I understand natural conversation and can help you with your calendar, contacts, reminders, and more. Just talk to me naturally - no specific commands needed!
                    </div>
                </div>

                <div class="thinking-indicator" id="thinkingIndicator">
                    <span>ü§î Thinking</span>
                    <div class="thinking-dots">
                        <div class="thinking-dot"></div>
                        <div class="thinking-dot"></div>
                        <div class="thinking-dot"></div>
                    </div>
                </div>

                <div class="input-section">
                    <input type="text" class="text-input" id="textInput" placeholder="Type naturally... 'Can you check my schedule?' or 'Remind me about dinner'" autocomplete="off">
                    <button class="voice-btn" id="voiceBtn">üé§</button>
                    <button class="send-btn" onclick="sendMessage()">Send</button>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <!-- API Setup -->
                <div class="api-setup" id="apiSetup">
                    <h3>üîë AI Brain Setup</h3>
                    <p style="font-size: 0.9rem; margin: 10px 0;">Add your OpenAI API key for intelligent responses:</p>
                    <input type="password" class="api-input" id="apiKey" placeholder="sk-proj-your-api-key-here">
                    <button class="btn primary" onclick="saveApiKey()">Connect AI Brain</button>
                    <button class="btn" onclick="testAI()">Test Connection</button>
                </div>

                <!-- Quick Settings -->
                <div class="sidebar-card">
                    <h3>‚öôÔ∏è Quick Settings</h3>
                    <div class="quick-settings">
                        <div class="setting-item">
                            <span>üé§ Voice Input</span>
                            <div class="toggle-switch active" id="voiceToggle" onclick="toggleSetting('voice')">
                                <div class="toggle-slider"></div>
                            </div>
                        </div>
                        <div class="setting-item">
                            <span>üîä Voice Response</span>
                            <div class="toggle-switch active" id="ttsToggle" onclick="toggleSetting('tts')">
                                <div class="toggle-slider"></div>
                            </div>
                        </div>
                        <div class="setting-item">
                            <span>üß† Context Memory</span>
                            <div class="toggle-switch active" id="memoryToggle" onclick="toggleSetting('memory')">
                                <div class="toggle-slider"></div>
                            </div>
                        </div>
                        <div class="setting-item">
                            <span>üì± Personal Data</span>
                            <div class="toggle-switch" id="dataToggle" onclick="toggleSetting('data')">
                                <div class="toggle-slider"></div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 15px;">
                        <label style="font-size: 0.9rem;">AI Personality:</label>
                        <select id="personalitySelect" onchange="updatePersonality()" style="width: 100%; padding: 8px; margin-top: 5px; border-radius: 8px; border: none; background: rgba(255,255,255,0.2); color: white;">
                            <option value="natural">üß† Natural & Intelligent</option>
                            <option value="friendly">üòä Friendly & Warm</option>
                            <option value="professional">üíº Professional & Concise</option>
                            <option value="casual">üòé Casual & Fun</option>
                            <option value="wise">ü¶â Wise & Thoughtful</option>
                        </select>
                    </div>
                </div>

                <!-- Personal Data -->
                <div class="sidebar-card">
                    <h3>üìä Your Personal Data</h3>
                    
                    <div class="context-info">
                        <div><span class="status-indicator" id="calendarStatus"></span>Calendar: <span id="calendarCount">0</span> events</div>
                        <div><span class="status-indicator" id="contactsStatus"></span>Contacts: <span id="contactsCount">0</span> people</div>
                        <div><span class="status-indicator" id="remindersStatus"></span>Reminders: <span id="remindersCount">0</span> active</div>
                    </div>

                    <div style="margin-top: 15px;">
                        <button class="btn" onclick="addSampleData()">üìù Add Sample Data</button>
                        <button class="btn" onclick="clearData()">üóëÔ∏è Clear All</button>
                    </div>

                    <div class="data-preview" id="dataPreview">
                        <div class="data-item">No personal data loaded</div>
                    </div>
                </div>

                <!-- Context Awareness -->
                <div class="sidebar-card">
                    <h3>üéØ AI Context</h3>
                    <div class="context-info" id="contextInfo">
                        <div>üí≠ <strong>Current Focus:</strong> <span id="currentFocus">General conversation</span></div>
                        <div>üïê <strong>Time Context:</strong> <span id="timeContext">Loading...</span></div>
                        <div>üìà <strong>Conversation:</strong> <span id="conversationContext">Just started</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class NaturalAIAssistant {
            constructor() {
                this.settings = {
                    apiKey: localStorage.getItem('natural_ai_api_key') || '',
                    voiceEnabled: true,
                    ttsEnabled: true,
                    memoryEnabled: true,
                    dataEnabled: false,
                    personality: 'natural'
                };
                
                this.personalData = {
                    calendar: JSON.parse(localStorage.getItem('ai_calendar') || '[]'),
                    contacts: JSON.parse(localStorage.getItem('ai_contacts') || '[]'),
                    reminders: JSON.parse(localStorage.getItem('ai_reminders') || '[]')
                };
                
                this.conversationContext = {
                    history: [],
                    currentFocus: 'general',
                    userPreferences: {},
                    lastInteraction: null
                };
                
                this.isListening = false;
                this.isSpeaking = false;
                this.recognition = null;
                this.synthesis = window.speechSynthesis;
                
                this.initializeVoiceRecognition();
                this.updateUI();
                this.updateTimeContext();
                this.loadConversationHistory();
                
                console.log('üß† Natural AI Assistant initialized');
            }
            
            initializeVoiceRecognition() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;
                    this.recognition.lang = 'en-US';
                    
                    this.recognition.onstart = () => {
                        this.isListening = true;
                        document.getElementById('voiceBtn').classList.add('listening');
                        document.getElementById('voiceBtn').textContent = 'üî¥';
                    };
                    
                    this.recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        this.processNaturalInput(transcript);
                    };
                    
                    this.recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        this.stopListening();
                    };
                    
                    this.recognition.onend = () => {
                        this.stopListening();
                    };
                }
            }
            
            async processNaturalInput(input) {
                this.addMessage(input, 'user');
                this.showThinking();
                
                try {
                    // Build natural context for AI
                    const context = this.buildIntelligentContext(input);
                    const response = await this.getIntelligentResponse(input, context);
                    
                    this.hideThinking();
                    this.addMessage(response, 'ai');
                    
                    // Update conversation context
                    this.updateConversationContext(input, response);
                    
                    // Speak response if enabled
                    if (this.settings.ttsEnabled) {
                        await this.speak(response);
                    }
                    
                    // Handle any actions mentioned in the response
                    await this.handleResponseActions(response, input);
                    
                } catch (error) {
                    this.hideThinking();
                    const fallbackResponse = this.getFallbackResponse(input);
                    this.addMessage(fallbackResponse, 'ai');
                    
                    if (this.settings.ttsEnabled) {
                        await this.speak(fallbackResponse);
                    }
                }
            }
            
            buildIntelligentContext(input) {
                const now = new Date();
                const timeOfDay = this.getTimeOfDay();
                const dayOfWeek = now.toLocaleDateString('en-US', { weekday: 'long' });
                
                let context = `You are a naturally intelligent personal AI assistant. Current context:\n`;
                context += `- Time: ${timeOfDay} on ${dayOfWeek}\n`;
                context += `- Date: ${now.toLocaleDateString()}\n`;
                context += `- Your personality: ${this.getPersonalityDescription()}\n`;
                
                if (this.settings.dataEnabled && this.personalData.calendar.length > 0) {
                    const todayEvents = this.getTodayEvents();
                    if (todayEvents.length > 0) {
                        context += `- Today's calendar: ${todayEvents.map(e => e.title).join(', ')}\n`;
                    }
                }
                
                if (this.settings.dataEnabled && this.personalData.reminders.length > 0) {
                    const activeReminders = this.personalData.reminders.filter(r => !r.completed);
                    if (activeReminders.length > 0) {
                        context += `- Active reminders: ${activeReminders.length} pending\n`;
                    }
                }
                
                if (this.conversationContext.history.length > 0) {
                    const recentHistory = this.conversationContext.history.slice(-3);
                    context += `- Recent conversation context: ${recentHistory.map(h => `User: "${h.input}" AI: "${h.response.substring(0, 50)}..."`).join(' | ')}\n`;
                }
                
                context += `\nRespond naturally and intelligently. If the user is asking about personal data (calendar, contacts, reminders) and data access is disabled, politely explain that you need permission to access that information. Be conversational, helpful, and match your personality. Keep responses concise but thoughtful.`;
                
                return context;
            }
            
            async getIntelligentResponse(input, context) {
                if (!this.settings.apiKey) {
                    return "I'd love to give you an intelligent response, but I need an OpenAI API key to access my AI brain. You can add it in the settings above!";
                }
                
                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.settings.apiKey}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: 'gpt-3.5-turbo',
                            messages: [
                                {
                                    role: 'system',
                                    content: context
                                },
                                {
                                    role: 'user',
                                    content: input
                                }
                            ],
                            max_tokens: 200,
                            temperature: 0.8 // Higher temperature for more natural responses
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    return data.choices[0].message.content.trim();
                    
                } catch (error) {
                    console.error('AI response error:', error);
                    throw error;
                }
            }
            
            getFallbackResponse(input) {
                const fallbacks = [
                    "I'm having trouble accessing my full AI capabilities right now. Could you check if my API key is set up correctly?",
                    "Something's not quite right with my connection. Let me try to help you anyway - what specifically did you need?",
                    "I'm experiencing some technical difficulties, but I'm still here to help! What can I assist you with?",
                    "My AI brain seems to be taking a coffee break! While I sort that out, is there something specific I can help with?"
                ];
                
                return fallbacks[Math.floor(Math.random() * fallbacks.length)];
            }
            
            getPersonalityDescription() {
                const personalities = {
                    natural: "You are naturally intelligent and conversational, like talking to a smart friend who understands context and nuance.",
                    friendly: "You are warm, enthusiastic, and encouraging. You're like a supportive friend who's always positive.",
                    professional: "You are efficient, polite, and business-like. You provide clear, actionable responses.",
                    casual: "You are relaxed, fun, and informal. You use casual language and humor when appropriate.",
                    wise: "You are thoughtful, insightful, and philosophical. You provide deeper perspectives on topics."
                };
                
                return personalities[this.settings.personality] || personalities.natural;
            }
            
            async handleResponseActions(response, originalInput) {
                // Intelligently detect if the AI wants to perform actions
                const lowerResponse = response.toLowerCase();
                const lowerInput = originalInput.toLowerCase();
                
                // Calendar actions
                if ((lowerInput.includes('schedule') || lowerInput.includes('calendar') || lowerInput.includes('meeting')) && 
                    (lowerResponse.includes('added') || lowerResponse.includes('scheduled'))) {
                    this.handleIntelligentCalendarAction(originalInput);
                }
                
                // Reminder actions
                if ((lowerInput.includes('remind') || lowerInput.includes('remember')) && 
                    (lowerResponse.includes('reminder') || lowerResponse.includes('remember'))) {
                    this.handleIntelligentReminderAction(originalInput);
                }
                
                // Update UI based on response
                this.updateContextBasedOnConversation(response);
            }
            
            handleIntelligentCalendarAction(input) {
                if (!this.settings.dataEnabled) return;
                
                // Extract event details naturally
                const eventInfo = this.extractEventInformation(input);
                if (eventInfo.title) {
                    this.personalData.calendar.push({
                        id: Date.now(),
                        title: eventInfo.title,
                        start: eventInfo.start || new Date(Date.now() + 3600000),
                        created: new Date()
                    });
                    
                    this.savePersonalData();
                    this.updateUI();
                }
            }
            
            handleIntelligentReminderAction(input) {
                if (!this.settings.dataEnabled) return;
                
                const reminderInfo = this.extractReminderInformation(input);
                if (reminderInfo.text) {
                    this.personalData.reminders.push({
                        id: Date.now(),
                        text: reminderInfo.text,
                        time: reminderInfo.time || new Date(Date.now() + 3600000),
                        completed: false,
                        created: new Date()
                    });
                    
                    this.savePersonalData();
                    this.updateUI();
                }
            }
            
            extractEventInformation(input) {
                // Natural language event extraction
                const result = { title: '', start: null };
                
                // Look for event titles
                const eventPatterns = [
                    /(?:schedule|add|create).*?(?:meeting|appointment|event).*?(?:with|for|about)\s+(.+?)(?:\s+(?:at|on|tomorrow|today|next))/i,
                    /(?:schedule|add|create)\s+(.+?)(?:\s+(?:at|on|tomorrow|today|next))/i
                ];
                
                for (const pattern of eventPatterns) {
                    const match = input.match(pattern);
                    if (match) {
                        result.title = match[1].trim();
                        break;
                    }
                }
                
                // Extract time naturally
                result.start = this.extractTimeInformation(input);
                
                return result;
            }
            
            extractReminderInformation(input) {
                const result = { text: '', time: null };
                
                const reminderPatterns = [
                    /remind\s+me\s+to\s+(.+?)(?:\s+(?:at|on|in|tomorrow|today))/i,
                    /remind\s+me\s+(.+?)(?:\s+(?:at|on|in|tomorrow|today))/i,
                    /remember\s+to\s+(.+?)(?:\s+(?:at|on|in|tomorrow|today))/i
                ];
                
                for (const pattern of reminderPatterns) {
                    const match = input.match(pattern);
                    if (match) {
                        result.text = match[1].trim();
                        break;
                    }
                }
                
                result.time = this.extractTimeInformation(input);
                
                return result;
            }
            
            extractTimeInformation(input) {
                const now = new Date();
                
                if (input.toLowerCase().includes('tomorrow')) {
                    const tomorrow = new Date(now);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    return tomorrow;
                }
                
                if (input.toLowerCase().includes('next week')) {
                    const nextWeek = new Date(now);
                    nextWeek.setDate(nextWeek.getDate() + 7);
                    return nextWeek;
                }
                
                // Time patterns
                const timeMatch = input.match(/(\d{1,2})(?::(\d{2}))?\s*(am|pm)/i);
                if (timeMatch) {
                    const targetTime = new Date(now);
                    let hour = parseInt(timeMatch[1]);
                    const minute = parseInt(timeMatch[2]) || 0;
                    const ampm = timeMatch[3].toLowerCase();
                    
                    if (ampm === 'pm' && hour !== 12) hour += 12;
                    if (ampm === 'am' && hour === 12) hour = 0;
                    
                    targetTime.setHours(hour, minute, 0, 0);
                    
                    // If time has passed today, assume tomorrow
                    if (targetTime <= now) {
                        targetTime.setDate(targetTime.getDate() + 1);
                    }
                    
                    return targetTime;
                }
                
                return null;
            }
            
            updateConversationContext(input, response) {
                if (!this.settings.memoryEnabled) return;
                
                this.conversationContext.history.push({
                    timestamp: new Date(),
                    input: input,
                    response: response
                });
                
                // Keep only recent history
                if (this.conversationContext.history.length > 20) {
                    this.conversationContext.history = this.conversationContext.history.slice(-20);
                }
                
                // Detect conversation focus
                this.updateConversationFocus(input, response);
                
                this.saveConversationHistory();
                this.updateContextDisplay();
            }
            
            updateConversationFocus(input, response) {
                const lowerInput = input.toLowerCase();
                
                if (lowerInput.includes('calendar') || lowerInput.includes('schedule') || lowerInput.includes('meeting')) {
                    this.conversationContext.currentFocus = 'calendar';
                } else if (lowerInput.includes('remind') || lowerInput.includes('remember')) {
                    this.conversationContext.currentFocus = 'reminders';
                } else if (lowerInput.includes('contact') || lowerInput.includes('call') || lowerInput.includes('phone')) {
                    this.conversationContext.currentFocus = 'contacts';
                } else if (lowerInput.includes('help') || lowerInput.includes('what can you')) {
                    this.conversationContext.currentFocus = 'help';
                } else {
                    this.conversationContext.currentFocus = 'general';
                }
                
                document.getElementById('currentFocus').textContent = this.conversationContext.currentFocus;
            }
            
            updateContextBasedOnConversation(response) {
                const totalConversations = this.conversationContext.history.length;
                document.getElementById('conversationContext').textContent = 
                    totalConversations === 0 ? 'Just started' :
                    totalConversations < 5 ? 'Getting acquainted' :
                    totalConversations < 15 ? 'Building rapport' : 'Deep conversation';
            }
            
            // UI Methods
            addMessage(message, sender) {
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                messageDiv.textContent = message;
                
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            showThinking() {
                document.getElementById('thinkingIndicator').style.display = 'flex';
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            hideThinking() {
                document.getElementById('thinkingIndicator').style.display = 'none';
            }
            
            async speak(text) {
                if (!this.settings.ttsEnabled || !this.synthesis) return;
                
                return new Promise((resolve) => {
                    this.synthesis.cancel();
                    this.isSpeaking = true;
                    
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.rate = 0.9;
                    utterance.pitch = 1.0;
                    utterance.volume = 1.0;
                    
                    utterance.onend = () => {
                        this.isSpeaking = false;
                        resolve();
                    };
                    
                    utterance.onerror = () => {
                        this.isSpeaking = false;
                        resolve();
                    };
                    
                    this.synthesis.speak(utterance);
                });
            }
            
            toggleVoiceInput() {
                if (this.isListening) {
                    this.stopListening();
                } else {
                    this.startListening();
                }
            }
            
            startListening() {
                if (this.recognition && !this.isListening && this.settings.voiceEnabled) {
                    try {
                        this.recognition.start();
                    } catch (error) {
                        console.error('Failed to start voice recognition:', error);
                    }
                }
            }
            
            stopListening() {
                this.isListening = false;
                document.getElementById('voiceBtn').classList.remove('listening');
                document.getElementById('voiceBtn').textContent = 'üé§';
            }
            
            updateUI() {
                // Update data counts
                document.getElementById('calendarCount').textContent = this.personalData.calendar.length;
                document.getElementById('contactsCount').textContent = this.personalData.contacts.length;
                document.getElementById('remindersCount').textContent = this.personalData.reminders.filter(r => !r.completed).length;
                
                // Update status indicators
                document.getElementById('calendarStatus').className = `status-indicator ${this.personalData.calendar.length > 0 ? 'active' : 'inactive'}`;
                document.getElementById('contactsStatus').className = `status-indicator ${this.personalData.contacts.length > 0 ? 'active' : 'inactive'}`;
                document.getElementById('remindersStatus').className = `status-indicator ${this.personalData.reminders.length > 0 ? 'active' : 'inactive'}`;
                
                // Update data preview
                this.updateDataPreview();
                
                // Update API setup visibility
                document.getElementById('apiSetup').style.display = this.settings.apiKey ? 'none' : 'block';
            }
            
            updateDataPreview() {
                const preview = document.getElementById('dataPreview');
                const allData = [
                    ...this.personalData.calendar.map(e => `üìÖ ${e.title}`),
                    ...this.personalData.contacts.map(c => `üë§ ${c.name}`),
                    ...this.personalData.reminders.filter(r => !r.completed).map(r => `‚è∞ ${r.text}`)
                ];
                
                if (allData.length === 0) {
                    preview.innerHTML = '<div class="data-item">No personal data loaded</div>';
                } else {
                    preview.innerHTML = allData.slice(0, 5).map(item => 
                        `<div class="data-item">${item}</div>`
                    ).join('');
                    
                    if (allData.length > 5) {
                        preview.innerHTML += `<div class="data-item">... and ${allData.length - 5} more items</div>`;
                    }
                }
            }
            
            updateTimeContext() {
                const now = new Date();
                const timeOfDay = this.getTimeOfDay();
                const dayOfWeek = now.toLocaleDateString('en-US', { weekday: 'long' });
                
                document.getElementById('timeContext').textContent = `${timeOfDay} on ${dayOfWeek}`;
                
                // Update every minute
                setTimeout(() => this.updateTimeContext(), 60000);
            }
            
            updateContextDisplay() {
                document.getElementById('currentFocus').textContent = this.conversationContext.currentFocus;
                this.updateContextBasedOnConversation();
            }
            
            getTimeOfDay() {
                const hour = new Date().getHours();
                if (hour < 6) return 'late night';
                if (hour < 12) return 'morning';
                if (hour < 17) return 'afternoon';
                if (hour < 21) return 'evening';
                return 'night';
            }
            
            getTodayEvents() {
                const today = new Date().toDateString();
                return this.personalData.calendar.filter(event => 
                    new Date(event.start).toDateString() === today
                );
            }
            
            // Data Management
            savePersonalData() {
                localStorage.setItem('ai_calendar', JSON.stringify(this.personalData.calendar));
                localStorage.setItem('ai_contacts', JSON.stringify(this.personalData.contacts));
                localStorage.setItem('ai_reminders', JSON.stringify(this.personalData.reminders));
            }
            
            saveConversationHistory() {
                if (this.settings.memoryEnabled) {
                    localStorage.setItem('ai_conversation_context', JSON.stringify(this.conversationContext));
                }
            }
            
            loadConversationHistory() {
                if (this.settings.memoryEnabled) {
                    const stored = localStorage.getItem('ai_conversation_context');
                    if (stored) {
                        const loaded = JSON.parse(stored);
                        this.conversationContext = { ...this.conversationContext, ...loaded };
                    }
                }
            }
        }
        
        // Global instance
        let assistant;
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            assistant = new NaturalAIAssistant();
            
            // Event listeners
            document.getElementById('voiceBtn').addEventListener('click', () => {
                assistant.toggleVoiceInput();
            });
            
            document.getElementById('textInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Load settings into UI
            document.getElementById('personalitySelect').value = assistant.settings.personality;
            if (assistant.settings.apiKey) {
                document.getElementById('apiKey').value = assistant.settings.apiKey;
            }
        });
        
        // Global functions
        function sendMessage() {
            const input = document.getElementById('textInput');
            const message = input.value.trim();
            
            if (message) {
                assistant.processNaturalInput(message);
                input.value = '';
            }
        }
        
        function saveApiKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (apiKey.startsWith('sk-')) {
                assistant.settings.apiKey = apiKey;
                localStorage.setItem('natural_ai_api_key', apiKey);
                assistant.updateUI();
                assistant.addMessage('AI brain connected successfully! Now I can provide intelligent responses.', 'ai');
            } else {
                alert('Please enter a valid OpenAI API key (starts with sk-)');
            }
        }
        
        function testAI() {
            if (!assistant.settings.apiKey) {
                alert('Please add your API key first');
                return;
            }
            
            assistant.processNaturalInput('Hello, can you hear me?');
        }
        
        function toggleSetting(setting) {
            const toggle = document.getElementById(`${setting}Toggle`);
            const isActive = toggle.classList.contains('active');
            
            toggle.classList.toggle('active');
            assistant.settings[setting + 'Enabled'] = !isActive;
            
            if (setting === 'data') {
                assistant.settings.dataEnabled = !isActive;
                if (assistant.settings.dataEnabled) {
                    assistant.addMessage('Personal data access enabled. I can now help you with calendar, contacts, and reminders!', 'ai');
                } else {
                    assistant.addMessage('Personal data access disabled. I\'ll only use general conversation.', 'ai');
                }
            }
        }
        
        function updatePersonality() {
            const personality = document.getElementById('personalitySelect').value;
            assistant.settings.personality = personality;
            
            const descriptions = {
                natural: 'Natural conversational AI ready',
                friendly: 'Friendly and warm AI assistant ready',
                professional: 'Professional AI assistant ready',
                casual: 'Casual and fun AI assistant ready',
                wise: 'Wise and thoughtful AI assistant ready'
            };
            
            document.getElementById('personalityStatus').textContent = descriptions[personality];
            assistant.addMessage(`My personality has been updated to ${personality}. How can I help you today?`, 'ai');
        }
        
        function addSampleData() {
            // Add sample calendar events
            assistant.personalData.calendar.push(
                {
                    id: Date.now(),
                    title: 'Team Meeting',
                    start: new Date(Date.now() + 3600000), // 1 hour from now
                    created: new Date()
                },
                {
                    id: Date.now() + 1,
                    title: 'Lunch with Sarah',
                    start: new Date(Date.now() + 7200000), // 2 hours from now
                    created: new Date()
                }
            );
            
            // Add sample contacts
            assistant.personalData.contacts.push(
                { id: 1, name: 'John Doe', phone: '+1234567890', type: 'WhatsApp' },
                { id: 2, name: 'Sarah Smith', phone: '+1234567891', type: 'Phone' }
            );
            
            // Add sample reminders
            assistant.personalData.reminders.push(
                {
                    id: Date.now(),
                    text: 'Buy groceries',
                    time: new Date(Date.now() + 3600000),
                    completed: false,
                    created: new Date()
                },
                {
                    id: Date.now() + 1,
                    text: 'Call dentist',
                    time: new Date(Date.now() + 86400000), // Tomorrow
                    completed: false,
                    created: new Date()
                }
            );
            
            assistant.savePersonalData();
            assistant.updateUI();
            assistant.addMessage('Sample personal data added! Now I have context about your schedule, contacts, and reminders.', 'ai');
        }
        
        function clearData() {
            if (confirm('Clear all personal data?')) {
                assistant.personalData = { calendar: [], contacts: [], reminders: [] };
                assistant.conversationContext.history = [];
                assistant.savePersonalData();
                assistant.saveConversationHistory();
                assistant.updateUI();
                assistant.addMessage('All personal data cleared.', 'ai');
            }
        }
    </script>
</body>
</html>